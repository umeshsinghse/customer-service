# LoadBalancer Service Fix for AWS EKS Subnet Issues
# This creates a separate LoadBalancer service with proper AWS annotations

apiVersion: v1
kind: Service
metadata:
  name: customer-service-loadbalancer
  namespace: customer-service
  labels:
    app: customer-service
  annotations:
    # Use Network Load Balancer (NLB) instead of Classic Load Balancer
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    # Internet-facing load balancer
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    # Enable cross-zone load balancing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    # Health check settings
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "HTTP"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/api/health"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "8080"
    # Target type for better performance
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    # Preserve client IP
    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: "preserve_client_ip.enabled=true"
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    name: http
  selector:
    app: customer-service
  # Preserve client IP
  externalTrafficPolicy: Local